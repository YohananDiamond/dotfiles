#!/usr/bin/env sh

# A script to find and load articles.
# Works better with fuzzy finders.

case $# in
  0) 
    if [ -z "$F_ARTICLES" ]; then
      echo "Please set \$F_ARTICLES for the articles folder or specify it here as \$1."
      exit 1
    fi
    ARTICLES="$F_ARTICLES"
    ;;
  1) ARTICLES="$1" ;;
  *) 
    echo "Invalid amount of arguments."
    exit 1
    ;;
esac

exists() {
  [ $# = 1 ] || return 2
  type "$1" >/dev/null 2>/dev/null
}

if exists "dmenu"; then
  if [ -n "$DISPLAY" ]; then
    choose() { dmenu -l 10 <<<"$1"; }
  else
    echo "dmenu was detected, but won't be used due to display not being found."
    exists "fzf" &&
      choose() { fzf <<<"$1"; }
  fi
elif exists "fzf"; then
  choose() { fzf <<<"$1"; }
else
  echo "No valid fuzzy finder found."
  echo "The valid ones are: dmenu, fzf"
  exit 1
fi

if [ -z "$DISPLAY" ] && exists "w3m"; then
  browse() { w3m $@; }
else
  browse() { nuke $@; }
fi

cd "$ARTICLES" || exit 1
CHOICE="$(choose "$(find . -mindepth 1 -maxdepth 1 | sed 's/^\.\///g' | grep '\.html$')")" && browse "$CHOICE"
