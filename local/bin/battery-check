#!/usr/bin/env python3
# vim: foldmethod=marker

# Battery checks to run in background.
# "Why is this in python?" -> because it looked trash in sh syntax.

import subprocess
import time

def read_file(path: str):
    contents = None
    with open(path, "r") as f:
        contents = f.read()
    return contents

def get_battery_level():
    return int(read_file("/sys/class/power_supply/BAT0/capacity"))

def get_charge_state():
    return read_file("/sys/class/power_supply/BAT0/status") == "Charging\n"

def send_notify(message: str, level: str = "normal"):
    subprocess.Popen(["notify-send", message, "-u", level])

# Main loop
notify = None
while True:
    battery_level = get_battery_level()
    is_charging = get_charge_state()

    if 20 < battery_level < 90:
        notify = None
    if (notify != "LOW") and (battery_level <= 20):
        notify = "LOW"
        if not is_charging:
            send_notify(f"Battery is low! ({battery_level:02d}%)", "critical")
    if (notify != "HIGH") and (battery_level >= 90):
        notify = "HIGH"
        if is_charging:
            send_notify(f"Battery is close to full! ({battery_level:02d}%)", "low")
    if (notify != "MAX") and (battery_level == 100):
        notify = "MAX"
        if is_charging:
            send_notify(f"Battery is full! ({battery_level:02d}%)")

    time.sleep(60)
